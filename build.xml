<?xml version="1.0" encoding='ISO-8859-1'?>
<!--

"How to build the Grinder" by Philip Aston.

Introduction
============

Ant
===

The Grinder build system is based on Jakarta Ant 1.3, which is a Java
building tool originally developed for the Jakarta Tomcat project but
now used in many other Apache projects and extended by many
developers.

Ant is a very handy tool that uses a build file written in XML (this
file) as building instructions. For more information refer to
"http://jakarta.apache.org/ant/".


What do I do?
=============

Do the following:

	1. Acquire and install Ant 1.4.1
	   (http://jakarta.apache.org/ant/index.html).

	2. Set/export ANT_HOME, JAVA_HOME and PATH as described
	   in the Ant user guide.

       	3. Type ant

Say 
	ant -projecthelp

for details of other targets. The compilation targets do depend on the
"clean" target, to rebuild you need to say "ant clean compile".

The build auto-detects what modules to build by checking your
CLASSPATH for classes the module depends on. You may have to unset
your CLASSPATH if this doesn't do what you want. Currently the
conditionally built modules are:

   HTTP SSL plugin (Needs the JSSE 1.0.2)
   TCPSniffer SSL engine (Needs the JSSE 1.0.2)
   TCPSniffer HTTP plugin filter (Needs Apache Jakarta Regexp 1.2)
   JUnit test cases (Needs JUnit 3.4 and Ant 1.3 optional.jar)
   ExampleJTidyStringBean (Needs JTidy and Xalan XPath support)
-->

<project name="The Grinder" default="all" basedir=".">

  <!-- =================================================================== -->
  <!-- Initialization target                                               -->
  <!-- =================================================================== -->
  <target name="init">
    <tstamp/>
    <!-- what -->
    <property name="Name" value="The Grinder"/>
    <property name="name" value="grinder"/>
    <property name="version" value="2.8.2"/>
    <property name="year" value="2002"/>

    <!-- options -->
    <available classname="com.sun.net.ssl.HostnameVerifier"
	       property="have.jsse" />

    <available classname="junit.framework.TestCase"
	       property="have.junit" />

    <available classname="org.apache.tools.ant.taskdefs.optional.junit.JUnitTask"
	       property="have.junit.task" />

    <available classname="org.apache.regexp.RE" property="have.regexp" />

    <available classname="javax.servlet.http.HttpServletRequest"
	       property="have.servlet"/>

    <available classname="org.w3c.tidy.Tidy" property="have.jtidy"/>

    <available classname="org.apache.xpath.XPathAPI" property="have.xpath"/>

    <condition property="have.jtidy-and-xpath">
      <and>
	<equals arg1="have.jtidy" arg2="true"/>
	<equals arg1="have.xpath" arg2="true"/>
      </and>
    </condition>

    <!-- javac switches -->
    <property name="debug" value="on"/>
    <property name="optimize" value="on"/>
    <property name="deprecation" value="on"/>

    <!-- source of all evil -->
    <property name="src.dir" value="src"/>
    <property name="tests.src.dir" value="tests-src"/>
    <property name="etc.dir" value="etc"/>
    <property name="examples.dir" value="examples"/>

    <!-- javadoc -->
    <property name="doc.dir" value="doc"/>
    <property name="javadoc.dir" value="${doc.dir}/javadoc"/>
    <property name="javadoc.packages" value="net.grinder.*"/>
    <property name="javadoc.css" value="${etc.dir}/javadoc.css"/>

    <!-- webapps, in general and specific -->
    <property name="webapps.dir" value="webapps"/>
    <property name="sniffer.webapp.dir" value="${webapps.dir}/sniff-n-grind"/>

    <!-- output -->
    <property name="build.dir" value="build"/>
    <property name="build.src" value="${build.dir}/src"/>
    <property name="build.classes" value="${build.dir}/classes"/>
    <property name="build.webapps" value="${build.dir}/webapps"/>
    <property name="tests.src" value="${build.dir}/tests-src"/>
    <property name="tests.classes" value="${build.dir}/tests-classes"/>
    <property name="lib.dir" value="lib"/>
    <property name="lib.jar" value="${name}.jar"/>
    <property name="dist.root" value="${build.dir}/distribution"/>
    <property name="dist.dir" value="${dist.root}/${name}-${version}"/>

    <!-- filter tokens -->
    <filter token="year" value="${year}"/>
    <filter token="version" value="${version}"/>
    <filter token="date" value="${TODAY}"/>

    <echo message="** Building ${Name} ${version} on ${TODAY} **"/>
  </target>

  <target name="all" depends="jar"/>

  <!-- =================================================================== -->
  <!-- Useful assertions                                                   -->
  <!-- =================================================================== -->
  <target name="assert-have-jsse" depends="init" unless="have.jsse">
   <fail message="Add JSSE 1.0.2 to your CLASSPATH to build this target"/>
  </target>

  <target name="assert-have-junit" depends="init" unless="have.junit">
   <fail message="Add JUnit 3.4 to your CLASSPATH to build this target"/>
  </target>

  <target name="assert-have-junit-task" depends="init"
	  unless="have.junit.task">
   <fail message="Install the Ant optional.jar to build this target"/>
  </target>

  <target name="assert-have-regexp" depends="init" unless="have.regexp">
   <fail message="Add Apache Regexp 1.2 to your CLASSPATH to build this target"/>
  </target>

  <target name="assert-have-servlet" depends="init" unless="have.servlet">
   <fail message="Add Servlet classes to your CLASSPATH to build this target"/>
  </target>

  <target name="assert-have-jtidy" depends="init" unless="have.jtidy">
   <fail message="Add JTidy classes to your CLASSPATH to build this target"/>
  </target>

  <target name="assert-have-xpath" depends="init" unless="have.xpath">
   <fail message="Add Xalan XPath classes to your CLASSPATH to build this target"/>
  </target>

  <target name="assert-have-everything"
	  depends="assert-have-jsse,assert-have-junit,assert-have-junit-task,assert-have-regexp,assert-have-servlet,assert-have-jtidy,assert-have-xpath">
  </target>


  <!-- =================================================================== -->
  <!-- Rules that prepare a filtered copy of the appropriate source code   -->
  <!-- =================================================================== -->
  <target name="prepare-src" depends="init">
    <copy todir="${build.src}" filtering="on">
      <fileset dir="${src.dir}">
        <exclude name="**/resources/*.gif"/>
        <exclude name="**/resources/*.html"/>
        <exclude name="**/resources/*.properties"/>
      </fileset>
    </copy>
  </target>

  <target name="prepare-test-src" depends="init">
    <copy todir="${tests.src}" filtering="on">
      <fileset dir="${tests.src.dir}"/>
    </copy>
  </target>


  <!-- =================================================================== -->
  <!-- Copy resources into the classes hierarcy                            -->
  <!-- =================================================================== -->
  <target name="copy-resources" depends="init"
	  description="Copies the resource files into build output">
    <copy todir="${build.classes}" filtering="off">
      <fileset dir="${src.dir}">
        <include name="**/resources/*.gif"/>
      </fileset>
    </copy>
    <copy todir="${build.classes}" filtering="on">
      <fileset dir="${src.dir}">
        <include name="**/resources/*.html"/>
        <include name="**/resources/*.properties*"/>
      </fileset>
    </copy>
  </target>


  <!-- =================================================================== -->
  <!-- Compilation rules                                    -->
  <!-- =================================================================== -->
  <target name="compile" depends="prepare-src"
	  description="Compiles the source.">
    <mkdir dir="${build.classes}"/>

    <echo message="Compiling HTTPClient code, ignore deprecation warnings..."/>

    <javac srcdir="${build.src}"
           destdir="${build.classes}"
           debug="${debug}"
           optimize="${optimize}"
		   deprecation="false"> <!-- Uses deprecated API's -->
       <include name="HTTPClient/**"/>
    </javac>

    <echo message="... HTTPClient code compiled."/>

    <javac srcdir="${build.src}"
           destdir="${build.classes}"
           debug="${debug}"
           optimize="${optimize}"
	   deprecation="${deprecation}">
       <exclude name="HTTPClient/**"/>
       <exclude name="**/HttpsPlugin.java" unless="have.jsse"/>
       <exclude name="**/SSLSnifferEngineImpl.java" unless="have.jsse"/>
       <exclude name="**/HttpPluginSnifferFilter.java" unless="have.regexp"/>
       <exclude name="**/HttpProxySnifferEngineImpl.java" unless="have.regexp"/>
       <exclude name="**/HttpsProxySnifferEngineImpl.java" unless="have.regexp,have.jsse"/>
       <exclude name="**/HttpsProxySnifferEngineImpl.java" unless="have.jsse"/>
       <exclude name="**/URLRewriteFilter.java" unless="have.regexp"/>
       <exclude name="**/JUnitPlugin.java" unless="have.junit"/>
       <exclude name="**/snifferwebapp" unless="have.servlet"/>
       <exclude name="**/ExampleJTidyStringBean.java" unless="have.jtidy-and-xpath"/>
    </javac>

  </target>

  <target name="compile-tests"
	  depends="assert-have-junit,prepare-test-src,compile"
	  description="Compiles the tests source">
    <mkdir dir="${tests.classes}"/>

    <javac srcdir="${tests.src}"
           destdir="${tests.classes}"
	   classpath="${build.classes}"
           debug="${debug}"
           optimize="${optimize}"
	   deprecation="${deprecation}">
    </javac>
  </target>


  <!-- =================================================================== -->
  <!-- Creates the jar                                                     -->
  <!-- =================================================================== -->
  <target name="jar" depends="compile, copy-resources"
	  description="Default target, creates lib/grinder.jar.">
    <mkdir dir="${lib.dir}"/>

    <jar jarfile="${lib.dir}/${lib.jar}"
         basedir="${build.classes}">
        <include name="net/grinder/"/>
        <include name="HTTPClient/"/>
        <exclude name="**/snifferwebapp"/>
    </jar>
  </target>

  <!-- =================================================================== -->
  <!-- Creates the sniff-n-grind war                                       -->
  <!-- =================================================================== -->
  <target name="sniff-war" depends="compile, copy-resources"
	  description="Creates webapps/sniff-n-grind.war">
	<mkdir dir="${build.webapps}"/>

	<war warfile="${build.webapps}/sniff-n-grind.war" 
		 webxml="${sniffer.webapp.dir}/WEB-INF/web.xml">
	  <fileset dir="${sniffer.webapp.dir}">
		<include name="*.jsp"/>
	  </fileset>
	  <classes dir="${build.classes}"
			   includes="**/snifferwebapp/**"/>
	</war>
  </target>

  <target name="testimage" depends="compile-tests,copy-resources">
    <mkdir dir="${lib.dir}"/>

    <jar jarfile="${lib.dir}/testimage.jar"
         manifest="etc/testimage.mf">
        <fileset dir="${build.classes}"
		 includes="net/grinder/console/swingui/resources/"/>
        <fileset dir="${tests.classes}"
		 includes="net/grinder/console/swingui/TestImage*.class"/>
        <fileset dir="${tests.src}"
		 includes="net/grinder/console/swingui/TestImage*.java"/>
    </jar>
  </target>


  <!-- =================================================================== -->
  <!-- Rules to run the tests                                              -->
  <!-- =================================================================== -->
  <target name="test"
	  depends="compile-tests,copy-resources,assert-have-junit-task"
	  description="Run the unit-tests.">
  <junit printsummary="false" haltonfailure="true">
    <classpath path="${tests.classes};${build.classes}"/>

    <batchtest>
      <formatter type="plain" usefile="false"/>
      <fileset dir="${tests.src}" includes="**/Test*.java"/>
    </batchtest>
  </junit>

  </target>


  <!-- =================================================================== -->
  <!-- Rules to create the API documentation                               -->
  <!-- =================================================================== -->
  <target name="javadoc" depends="init" description="Generates the javadoc.">
    <mkdir dir="${javadoc.dir}"/>
    <javadoc packagenames="${javadoc.packages}"
             destdir="${javadoc.dir}"
             author="true"
             version="false"
             use="false"
             noindex="false"
             windowtitle="${Name}"
             doctitle="${Name}"
             bottom="Copyright &#169; ${year} Paco Gómez, Philip Aston. All Rights Reserved."
             stylesheetfile="${javadoc.css}"
	     package="true">
	    <sourcepath>
	      <pathelement path="${src.dir}"/>
	      <pathelement path="${tests.src.dir}"/>
	    </sourcepath>
    </javadoc>
  </target>


  <!-- =================================================================== -->
  <!-- Creates the distribution hierachy                                   -->
  <!-- =================================================================== -->
  <target name="distribute-doc" depends="javadoc">
    <copy todir="${dist.dir}/${doc.dir}">
      <fileset dir="${doc.dir}"/>
    </copy>
  </target>

  <target name="distribution-hierarchy" depends="compile,jar">

    <copy todir="${dist.dir}/${src.dir}" filtering="on">
      <fileset dir="${src.dir}">
	<exclude name="TAGS"/>
	<exclude name="**/.xvpics/**"/>
      </fileset>
    </copy>

    <copy todir="${dist.dir}/${tests.src.dir}" filtering="on">
      <fileset dir="${tests.src.dir}">
	<exclude name="TAGS"/>
	<exclude name="**/.xvpics/**"/>
      </fileset>
    </copy>

    <copy todir="${dist.dir}/${webapps.dir}" filtering="on">
      <fileset dir="${webapps.dir}"/>
    </copy>

    <copy file="${lib.dir}/${lib.jar}"
	  tofile="${dist.dir}/${lib.dir}/${lib.jar}"/>

    <copy todir="${dist.dir}/${etc.dir}">
      <fileset dir="${etc.dir}" excludes="buildenv.sh,munge-license.pl,setenv.sh"/>
    </copy>

    <copy todir="${dist.dir}/${examples.dir}">
      <fileset dir="${examples.dir}" excludes="**/log/**"/>
    </copy>

    <copy todir="${dist.dir}" filtering="on">
      <fileset dir="."
	       includes="build.xml, AUTHORS, ChangeLog, CHANGES, LICENSE, README, TODO"
	       excludes="prj.el"/>
    </copy>
  </target>

  <!-- =================================================================== -->
  <!-- Packages the distribution as .jar                                   -->
  <!-- =================================================================== -->
  <target name="dist" depends="distribution-hierarchy"
	  description="Generates a distribution jar.">
    <jar jarfile="${name}-pre-${version}-${DSTAMP}.jar"
	 basedir="${dist.root}"/>
  </target>

  <target name="release" depends="assert-have-everything,realclean,test,distribution-hierarchy,distribute-doc"
	  description="Generates a release jar.">
<!--      <cvs command="tag -R release_${version}" noexec="true"/> -->
    <mkdir dir="releases"/>
    <jar jarfile="releases/${name}-${version}.jar" basedir="${dist.root}"/>

    <echo message="****************************************************"/>
    <echo message="*** Now say 'cvs tag -R release_${version}"/>
    <echo message="*** and update the version number in build.xml"/>
    <echo message="***"/>
    <echo message="*** If you forgot to update the ChangeLog or commit"/>
    <echo message="*** everything, take a deep breath and try again."/>
    <echo message="****************************************************"/>
  </target>

  <!-- =================================================================== -->
  <!-- Clean targets                                                       -->
  <!-- =================================================================== -->
  <target name="clean" depends="init" description="Removes class files.">
    <delete dir="${build.dir}"/>
  </target>

  <target name="realclean" depends="clean"
	  description="Removes all generated files and temporary files.">
    <delete dir="${dist.root}"/>
    <delete dir="${javadoc.dir}"/>
    <delete dir="${lib.dir}"/>
    <delete>
      <fileset dir="." includes="**/*~" defaultexcludes="no"/>
    </delete>

  </target>

</project>

<!-- End of file -->
